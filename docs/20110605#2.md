# FreeBSDのルートファイルシステムをgeliで暗号化する(2)

2011-06-05作成

※「[http://blogs.yahoo.co.jp/alpha3166/4222725.html FreeBSDのルートファイルシステムをgeliで暗号化する(1)]」からのつづき

今度は/dev/ad0s1aにブート用のカーネルをコピーします。
まず/dev/ad0s1の中にBSDパーティションを作ります。aパーティションだけなので、デフォルトのラベルで良いでしょう。一緒に-Bをつけてブートコードをインストールしておきます。
  Fixit# '''bsdlabel -w -B /dev/ad0s1'''
次にファイルシステムを作成します。
  Fixit# '''newfs -U /dev/ad0s1a'''
  /dev/ad0s1a: 2047.3MB (4192884 sectors) block size 16384, fragment size 2048
          using 12 cylinder groups of 183.77MB, 11761 blks, 23552 inodes.
          with soft updates
  super-block backups (for fsck -b #) at:
   160, 376512, 752864, 1129216, 1505568, 1881920, 2558272, 2634624, 3010976,
   3387328, 3763680, 4140032
適当にマウントポイントを作って(ここでは/mnt3とします)マウントします。
  Fixit# '''mkdir /mnt3'''
  Fixit# '''mount /dev/ad0s1a /mnt3'''
/mnt/bootをまるごと/mnt3にコピーします。
  Fixit# '''cp -Rpv /mnt/boot /mnt3'''
/mnt3にもetcを作ってfstabをコピーします。
  Fixit# '''mkdir /mnt3/etc'''
  Fixit# '''cp /mnt/etc/fstab /mnt3/etc'''
コピーしたfstabはそのままでも構いませんが、実際にはルートファイルシステムの情報だけあれば十分なので、それ以外の行は削除しておきます。
  Fixit# '''cd /mnt3/etc'''
  Fixit# '''vi fstab'''
中身は下記。
{{{
/dev/ad0s2.elia /    ufs  rw 1 1
}}}

ここまでくれば、HDDから起動可能になっているはずですので、exitでFixitを抜けて、再起動してください。
起動時にad0s2のパスフレーズを聞かれます。「Enter passphrase for ad0s2: 」というプロンプトが出たら、パスフレーズを入力してください (直後にUSB関連のメッセージが出てプロンプトが分かりにくくなることがありますが、カーネルはちゃんと入力を待っているので気にせず入力すれば大丈夫です)

これ以降はrootでログインし、sysinstallなどで通常と同じく設定を進められます。

ちなみに、ad0s2のパスフレーズはgeli setkeyで変更できます(umountやgeli detachなどは特に必要ないようです)。
  # '''geli setkey /dev/ad0s2'''
  Enter new passphrase:
  Reenter new passphrase: 
  Note, that the master key encrypted with old keys and/or passphrase may still 
  exists in a metadata backup file.

※バージョンメモ
・FreeBSD 8.2-RELEASE
